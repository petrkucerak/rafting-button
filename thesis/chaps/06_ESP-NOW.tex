% Lokální makra patří do hlavního souboru, ne sem.
% Tady je mám výjimečně proto, že chci nechat hlavní soubor bez maker,
% která jsou jen pro tento dokument. Uživatelé si pravděpodobně budou
% hlavní soubor kopírovat do svého dokumentu.

\def\ctustyle{{\ssr CTUstyle}}
\def\ttb{\tt\char`\\} % pro tisk kontrolních sekvencí v tabulkách

\label[ESPNOWChap]
\chap Technologie ESP-NOW

Kapitola se věnuje popisu technologie ESP-NOW, na které je kompletně vybudovaná síťová infrastruktura celého řešení.

\sec Popis technologie

Protokol {\sbf ESP-NOW} je definovaný firmou Espressif speciálně pro procesory ESP32, ESP8266, ESP32-S a ESP32-C. Technologie se od Wifi či Bluetoothe LE liší tím, že horních pět vrstev OSI modelu spojuje do jedné zvané ESP-NOW. Díky tomu je protokol sice méně robustní, naopak je díky němu možné dosáhnout vyšších rychlostí za menší cenu výpočetní síly.

\medskip
\clabel[ESPNOW-ProtocolStack]{Vizualizace zasazení protokolu ESP-NOW do OSI modelu}
\picw=16cm \cinspic img/protocol-stack.png
\caption/f Vizualizace zasazení protokolu ESP-NOW do OSI modelu.~\cite[E7xNXczajtMU8qxH]
\medskip

Protokol je flexibilní, protože dokáže přenášet data jak v {\em unicast} tak v {\em brodcast} módu a podporuje jak {\em one-to-many}, tak {\em many-to-many} komunikaci.

\secc Formát rámce

Výchozí přenosová rychlost ({\em bit rate}) ESP-NOW je 1 MBps. Rychlost jde měnit pomocí metod definovaných protokolem. Formát rámce vychází z definice {\em IEEE 802.11},\fnote{{\em IEEE 802.11} kapitola {\em 9.6.7.11 Vendor Specific Public Action frame format}.} konkretně tzv. {\em Action Format}.~\cite[2zPvvpoRaPgJFnf1, 9363693]

\begitems
* {\sbf MAC Header} (24 bytes)
* {\sbf Category Code} (1 byte) indikující typ {\em Action Frame}. V případě ESP-NOW se jedná o tzv. {\em vendor-specific action frame}, a proto je hodnota nastavena na 127.
* {\sbf Organization Identifier} (3 bytes) je jedinečný identifikátor. V případě ESP-NOW jde o hodnotu "0x18fe34", která tvoří první 3 byty MAC adresy příslušící firmě Espressif.
* {\sbf Random Values} (4 bytes) je náhodná hodnota, která se používá k prevenci před relay útokem.\fnote{{\sbf Relay útok} je kyberbezpečnostní útok využívající techniky {\em men-in-the-middle}. Pro více podrobností doporučuji navštívit \url{https://en.wikipedia.org/wiki/Relay_attack}.}
* {\sbf Vendor Specific Content} (7{\sim}255 bytes) samotný obsah protokolu, který je tvořen vloženým framem.
    \begitems
    * {\sbf Element ID} (1 byte) hodnota je nastavena na "221" pro indikaci začátku {\em vendor-specific} části.
    * {\sbf Length} (1 byte) je celková velikost částí {\em Organization Identifier}, {\em Type}, {\em Version} a {\em Body}.
    * {\sbf Organization Identifier} (3 bytes) stejná hodnota jako v nadřazeném rámci, do kterého je tento zapouzdřen. Jedná o hodnotu "0x18fe34", která odpovídá prvním třem bajtům MAC adres příslušících firmě Espressif.
    * {\sbf Type} (1 byte) určuje typ action rámce od Espressifu. V případě užití ESP-NOW je hodnota rovna "4".
    * {\sbf Version} (1 byte) pole pro nastavení konkrétní verze.
    * {\sbf Body} (0{\sim}248 bytes\fnote{V oficiální dokumentaci byla v době kdy jsem na práci pracoval chyba. Body bylo definované tak, že může dosahovat velikosti až 250 bajtů. To ale není možné, jelikož součet by přesáhl maximální povolenou velikost, tedy 255 bajtů pro {\em Vendor Specific Content}. Chybu jsem nahlásil a věřím, že bude co nejdříve opravena. \url{https://github.com/espressif/esp-now/issues/59}}) tělo samotného rámce obsahující zprávu.
    \enditems
* {\sbf FCS} (4 bytes) frame check sequence
\enditems

\medskip
\clabel[ESP-NOW-Frame-01-img]{ESP-NOW Action Frame}
\picw=14cm \cinspic img/ESP-NOW-frame-01.png
\caption/f Vizualizace ESP-NOW Action Frame.
\medskip

\medskip
\clabel[ESP-NOW-Frame-02-img]{ESP-NOW Content Frame}
\picw=14cm \cinspic img/ESP-NOW-frame-01.png
\caption/f Vizualizace ESP-NOW Content Frame.
\medskip

Protokol ESP-NOW má několik dalších odlišností oproti klasické komunikaci dle IEEE 802.11. Liší se kontrolním rámcem ({\em Frame Control})\fnote{Definovaném v {\em IEEE 802.11} kapitola {\em 9.2.4.1 Frame Control field}} v tom, že bity "FromDS" a "ToDS" jsou nulové a v obecném rámci ({\em General frame formát})\fnote{Definovaný v {\em IEEE 802.11} kapitola {\em 9.2.3 General frame format}}, pro který platí, že:

\begitems
* v první adrese ({\em Address 1}) je uložena cílová destinace ve formě MAC adresy,
* druhá adresa ({\em Address 2}) ukládá adresu zdroje
* a třetí adresa ({\em Address 3}) je vždy natavena na vysílání brodcastem, tedy na adresu "0xff:0xff:0xff:0xff:0xff:0xff".
\enditems

\secc Typy vysílání

\secc Bezpečnost a šifrování

Protokol ESP-NOw pro šifrování využívá metody CCMP\fnote{Definované v IEEE 802.11-2012}

\secc Limity technologie

\sec Navržení implementace